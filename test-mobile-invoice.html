<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CompatibilitÃ© Mobile - Facture</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .invoice-link {
            display: block;
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .invoice-link:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
        }
        
        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .test-container {
                padding: 15px;
            }
            .test-section {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” Test CompatibilitÃ© Mobile - Facture</h1>
        
        <div class="test-section">
            <h2>ğŸ“± Informations de l'appareil</h2>
            <div class="device-info" id="device-info">
                Chargement des informations...
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸŒ Tests de compatibilitÃ©</h2>
            <div id="compatibility-tests">
                ExÃ©cution des tests...
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”— Test du lien de facture</h2>
            <p>Cliquez sur le lien ci-dessous pour tester l'accÃ¨s Ã  la facture :</p>
            <a href="/api/invoice?invoice=ENIXIS_20251028_TEST&name=Test%20Mobile&email=test%40mobile.com&phone=%2B22812345678&service=%F0%9F%8E%93%20Formation%20Test&price=30000&delivery=standard&payment=Test%20Mobile" 
               class="invoice-link" 
               id="invoice-link"
               target="_blank">
                ğŸ“„ Ouvrir Facture Test
            </a>
            <div id="link-test-result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”§ Tests techniques</h2>
            <div id="technical-tests">
                ExÃ©cution des tests techniques...
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ RÃ©sultats des tests</h2>
            <div id="test-summary">
                Tests en cours...
            </div>
        </div>
    </div>

    <script>
        // Informations sur l'appareil
        function getDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenWidth: screen.width,
                screenHeight: screen.height,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio,
                touchSupport: 'ontouchstart' in window,
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
                isAndroid: /Android/.test(navigator.userAgent),
                browser: getBrowserInfo(),
                timestamp: new Date().toISOString()
            };
            
            return info;
        }
        
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            if (ua.includes('Opera')) return 'Opera';
            return 'Inconnu';
        }
        
        // Tests de compatibilitÃ©
        function runCompatibilityTests() {
            const tests = [];
            
            // Test 1: Support JavaScript
            tests.push({
                name: 'Support JavaScript',
                status: 'success',
                message: 'JavaScript est activÃ© et fonctionne'
            });
            
            // Test 2: Support des URL avec paramÃ¨tres
            try {
                const testUrl = new URL('https://example.com/test?param=value&encoded=%20test');
                tests.push({
                    name: 'Support URL avec paramÃ¨tres',
                    status: 'success',
                    message: 'Les URL avec paramÃ¨tres sont supportÃ©es'
                });
            } catch (e) {
                tests.push({
                    name: 'Support URL avec paramÃ¨tres',
                    status: 'error',
                    message: 'Erreur avec les URL: ' + e.message
                });
            }
            
            // Test 3: Support encodeURIComponent/decodeURIComponent
            try {
                const testString = 'Test Ã©Ã Ã§ 123 @#$%';
                const encoded = encodeURIComponent(testString);
                const decoded = decodeURIComponent(encoded);
                if (decoded === testString) {
                    tests.push({
                        name: 'Encodage/DÃ©codage URL',
                        status: 'success',
                        message: 'L\'encodage URL fonctionne correctement'
                    });
                } else {
                    tests.push({
                        name: 'Encodage/DÃ©codage URL',
                        status: 'error',
                        message: 'ProblÃ¨me avec l\'encodage URL'
                    });
                }
            } catch (e) {
                tests.push({
                    name: 'Encodage/DÃ©codage URL',
                    status: 'error',
                    message: 'Erreur encodage: ' + e.message
                });
            }
            
            // Test 4: Support localStorage
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                tests.push({
                    name: 'Support localStorage',
                    status: value === 'value' ? 'success' : 'error',
                    message: value === 'value' ? 'localStorage fonctionne' : 'localStorage ne fonctionne pas'
                });
            } catch (e) {
                tests.push({
                    name: 'Support localStorage',
                    status: 'error',
                    message: 'localStorage non disponible: ' + e.message
                });
            }
            
            // Test 5: Support fetch API
            tests.push({
                name: 'Support Fetch API',
                status: typeof fetch !== 'undefined' ? 'success' : 'error',
                message: typeof fetch !== 'undefined' ? 'Fetch API disponible' : 'Fetch API non disponible'
            });
            
            // Test 6: Support des Promises
            tests.push({
                name: 'Support Promises',
                status: typeof Promise !== 'undefined' ? 'success' : 'error',
                message: typeof Promise !== 'undefined' ? 'Promises supportÃ©es' : 'Promises non supportÃ©es'
            });
            
            return tests;
        }
        
        // Tests techniques spÃ©cifiques
        function runTechnicalTests() {
            const tests = [];
            
            // Test de l'URL de facture
            const invoiceUrl = '/api/invoice?invoice=ENIXIS_20251028_TEST&name=Test%20Mobile&email=test%40mobile.com&phone=%2B22812345678&service=%F0%9F%8E%93%20Formation%20Test&price=30000&delivery=standard&payment=Test%20Mobile';
            
            tests.push({
                name: 'Construction URL facture',
                status: 'info',
                message: `URL gÃ©nÃ©rÃ©e: ${invoiceUrl}`
            });
            
            // Test des caractÃ¨res spÃ©ciaux
            const specialChars = 'ğŸ“ Formation Coaching Emploi';
            const encoded = encodeURIComponent(specialChars);
            tests.push({
                name: 'Encodage caractÃ¨res spÃ©ciaux',
                status: 'info',
                message: `Original: "${specialChars}" â†’ EncodÃ©: "${encoded}"`
            });
            
            // Test de la longueur d'URL
            const fullUrl = `https://enixis-corp.vercel.app${invoiceUrl}`;
            tests.push({
                name: 'Longueur URL',
                status: fullUrl.length > 2048 ? 'warning' : 'success',
                message: `Longueur: ${fullUrl.length} caractÃ¨res ${fullUrl.length > 2048 ? '(peut poser problÃ¨me sur certains navigateurs)' : '(OK)'}`
            });
            
            return tests;
        }
        
        // Afficher les rÃ©sultats
        function displayResults(containerId, tests) {
            const container = document.getElementById(containerId);
            container.innerHTML = tests.map(test => `
                <div class="test-result ${test.status}">
                    <strong>${test.name}:</strong> ${test.message}
                </div>
            `).join('');
        }
        
        // Test du lien de facture
        function testInvoiceLink() {
            const link = document.getElementById('invoice-link');
            const resultDiv = document.getElementById('link-test-result');
            
            link.addEventListener('click', function(e) {
                resultDiv.innerHTML = '<div class="test-result info">ğŸ”„ Test du lien en cours... VÃ©rifiez si la facture s\'ouvre correctement.</div>';
                
                // VÃ©rifier aprÃ¨s un dÃ©lai si la page s'est ouverte
                setTimeout(() => {
                    resultDiv.innerHTML += '<div class="test-result warning">âš ï¸ Si la facture ne s\'ouvre pas, il y a un problÃ¨me de compatibilitÃ©.</div>';
                }, 3000);
            });
        }
        
        // GÃ©nÃ©rer un rÃ©sumÃ©
        function generateSummary(compatibilityTests, technicalTests) {
            const allTests = [...compatibilityTests, ...technicalTests];
            const successCount = allTests.filter(t => t.status === 'success').length;
            const errorCount = allTests.filter(t => t.status === 'error').length;
            const warningCount = allTests.filter(t => t.status === 'warning').length;
            
            let summaryClass = 'success';
            let summaryMessage = 'âœ… Tous les tests sont passÃ©s avec succÃ¨s';
            
            if (errorCount > 0) {
                summaryClass = 'error';
                summaryMessage = `âŒ ${errorCount} erreur(s) dÃ©tectÃ©e(s) - CompatibilitÃ© limitÃ©e`;
            } else if (warningCount > 0) {
                summaryClass = 'warning';
                summaryMessage = `âš ï¸ ${warningCount} avertissement(s) - CompatibilitÃ© partielle`;
            }
            
            return {
                class: summaryClass,
                message: summaryMessage,
                details: `Tests rÃ©ussis: ${successCount}, Erreurs: ${errorCount}, Avertissements: ${warningCount}`
            };
        }
        
        // Initialisation
        window.addEventListener('load', function() {
            // Afficher les informations de l'appareil
            const deviceInfo = getDeviceInfo();
            document.getElementById('device-info').innerHTML = Object.entries(deviceInfo)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
            
            // ExÃ©cuter les tests de compatibilitÃ©
            const compatibilityTests = runCompatibilityTests();
            displayResults('compatibility-tests', compatibilityTests);
            
            // ExÃ©cuter les tests techniques
            const technicalTests = runTechnicalTests();
            displayResults('technical-tests', technicalTests);
            
            // GÃ©nÃ©rer le rÃ©sumÃ©
            const summary = generateSummary(compatibilityTests, technicalTests);
            document.getElementById('test-summary').innerHTML = `
                <div class="test-result ${summary.class}">
                    <strong>${summary.message}</strong><br>
                    ${summary.details}
                </div>
            `;
            
            // Configurer le test du lien
            testInvoiceLink();
            
            console.log('ğŸ” Tests de compatibilitÃ© mobile terminÃ©s');
            console.log('ğŸ“± Informations appareil:', deviceInfo);
            console.log('âœ… Tests compatibilitÃ©:', compatibilityTests);
            console.log('ğŸ”§ Tests techniques:', technicalTests);
        });
    </script>
</body>
</html>