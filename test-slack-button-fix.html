<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bouton Slack - Facture PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .slack-simulation {
            background: #4a154b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .slack-attachment {
            background: #f8f9fa;
            color: #333;
            margin: 10px 0;
            padding: 15px;
            border-left: 4px solid #28a745;
            border-radius: 0 8px 8px 0;
        }
        
        .slack-button {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 5px 0 0;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .slack-button:hover {
            background: #218838;
            color: white;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .url-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Bouton Slack - Facture PDF</h1>
        <p>Ce test simule la notification Slack avec le bouton "Ouvrir PDF" et v√©rifie son fonctionnement.</p>
        
        <div class="test-section">
            <h2>üìä G√©n√©ration de l'URL de Facture</h2>
            <button class="test-button" onclick="generateTestUrl()">üîó G√©n√©rer URL Test</button>
            <div id="url-generation-result"></div>
            <div id="generated-url" class="url-display" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>üí¨ Simulation Notification Slack</h2>
            <div class="slack-simulation">
                <div style="margin-bottom: 15px;">
                    <strong>üì¶ COMMANDE EN COURS - ENIXIS_20251028_TEST</strong>
                </div>
                
                <div class="slack-attachment">
                    <div style="font-weight: bold; margin-bottom: 10px;">üìÑ Facture PDF - T√©l√©chargeable</div>
                    <div style="margin-bottom: 10px;">üìÑ Facture ENIXIS_20251028_TEST - Accessible via le lien de t√©l√©chargement</div>
                    <a href="#" id="slack-pdf-button" class="slack-button" target="_blank">üì• Ouvrir PDF</a>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        Facture ENIXIS_20251028_TEST - T√©l√©chargeable depuis n'importe quel appareil
                    </div>
                </div>
            </div>
            <div id="slack-test-result"></div>
        </div>
        
        <div class="test-section">
            <h2>üîß Tests de Fonctionnalit√©</h2>
            <button class="test-button" onclick="testUrlGeneration()">üß™ Tester G√©n√©ration URL</button>
            <button class="test-button" onclick="testSlackButton()">üîó Tester Bouton Slack</button>
            <button class="test-button" onclick="testMobileCompatibility()">üì± Tester Compatibilit√© Mobile</button>
            <div id="functionality-results"></div>
        </div>
        
        <div class="test-section">
            <h2>üìã R√©sultats des Tests</h2>
            <div id="test-summary"></div>
        </div>
    </div>

    <script>
        // Donn√©es de test
        const testData = {
            invoice: 'ENIXIS_20251028_TEST',
            name: 'Test Client Slack',
            email: 'test@slack.com',
            phone: '+22812345678',
            service: 'üéì Formation Test Slack',
            price: 25000,
            delivery: 'standard',
            payment: 'Test Payment'
        };
        
        let generatedUrl = '';
        let testResults = [];
        
        // Fonction pour g√©n√©rer une URL optimis√©e (copie de la fonction du syst√®me)
        function generateOptimizedInvoiceUrl(invoiceNumber, data) {
            const baseUrl = 'https://enixis-corp.vercel.app/api/invoice';
            
            // Calculer la longueur de l'URL traditionnelle
            const traditionalParams = new URLSearchParams({
                invoice: invoiceNumber,
                name: data.name,
                email: data.email,
                phone: data.phone,
                service: data.service,
                price: data.price.toString(),
                delivery: data.delivery,
                payment: data.payment
            });
            const traditionalUrl = `${baseUrl}?${traditionalParams.toString()}`;
            
            // Si l'URL traditionnelle est trop longue, utiliser la version optimis√©e
            if (traditionalUrl.length > 1024) {
                console.log(`‚ö†Ô∏è URL traditionnelle trop longue (${traditionalUrl.length} caract√®res), utilisation de la version optimis√©e`);
                
                try {
                    const encodedData = btoa(JSON.stringify(data));
                    const optimizedUrl = `${baseUrl}?invoice=${invoiceNumber}&data=${encodedData}`;
                    
                    console.log(`‚úÖ URL optimis√©e g√©n√©r√©e (${optimizedUrl.length} caract√®res, r√©duction de ${((traditionalUrl.length - optimizedUrl.length) / traditionalUrl.length * 100).toFixed(1)}%)`);
                    return optimizedUrl;
                } catch (error) {
                    console.error('‚ùå Erreur g√©n√©ration URL optimis√©e:', error);
                    return traditionalUrl;
                }
            } else {
                console.log(`‚úÖ URL traditionnelle utilis√©e (${traditionalUrl.length} caract√®res)`);
                return traditionalUrl;
            }
        }
        
        // G√©n√©rer l'URL de test
        function generateTestUrl() {
            try {
                generatedUrl = generateOptimizedInvoiceUrl(testData.invoice, testData);
                
                document.getElementById('generated-url').style.display = 'block';
                document.getElementById('generated-url').textContent = generatedUrl;
                
                document.getElementById('url-generation-result').innerHTML = `
                    <div class="result success">
                        ‚úÖ URL g√©n√©r√©e avec succ√®s (${generatedUrl.length} caract√®res)
                    </div>
                `;
                
                // Mettre √† jour le bouton Slack
                document.getElementById('slack-pdf-button').href = generatedUrl;
                
                testResults.push({
                    test: 'G√©n√©ration URL',
                    status: 'success',
                    message: `URL g√©n√©r√©e (${generatedUrl.length} caract√®res)`
                });
                
                updateTestSummary();
                
            } catch (error) {
                document.getElementById('url-generation-result').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur g√©n√©ration URL: ${error.message}
                    </div>
                `;
                
                testResults.push({
                    test: 'G√©n√©ration URL',
                    status: 'error',
                    message: error.message
                });
                
                updateTestSummary();
            }
        }
        
        // Tester la g√©n√©ration d'URL
        function testUrlGeneration() {
            const results = [];
            
            // Test 1: URL courte
            const shortData = { ...testData, service: 'Test' };
            const shortUrl = generateOptimizedInvoiceUrl(shortData.invoice, shortData);
            results.push({
                name: 'URL Courte',
                status: shortUrl.length < 1024 ? 'success' : 'warning',
                message: `${shortUrl.length} caract√®res`
            });
            
            // Test 2: URL longue
            const longData = { ...testData, service: 'üéì Formation Tr√®s Longue avec Beaucoup de D√©tails et Caract√®res Sp√©ciaux √©√†√ß' };
            const longUrl = generateOptimizedInvoiceUrl(longData.invoice, longData);
            results.push({
                name: 'URL Longue',
                status: 'success',
                message: `${longUrl.length} caract√®res (optimis√©e automatiquement)`
            });
            
            // Test 3: Caract√®res sp√©ciaux
            const specialData = { ...testData, name: '√âdem √áyrille S√ñSS√ñ√úV√é', service: 'üéìüöÄüíº Formation Sp√©ciale' };
            const specialUrl = generateOptimizedInvoiceUrl(specialData.invoice, specialData);
            results.push({
                name: 'Caract√®res Sp√©ciaux',
                status: 'success',
                message: `${specialUrl.length} caract√®res (encodage correct)`
            });
            
            displayResults('functionality-results', results);
            
            testResults = testResults.concat(results.map(r => ({
                test: r.name,
                status: r.status,
                message: r.message
            })));
            
            updateTestSummary();
        }
        
        // Tester le bouton Slack
        function testSlackButton() {
            if (!generatedUrl) {
                generateTestUrl();
            }
            
            const results = [];
            
            // V√©rifier que l'URL est d√©finie
            const slackButton = document.getElementById('slack-pdf-button');
            if (slackButton.href && slackButton.href !== '#') {
                results.push({
                    name: 'Bouton Slack URL',
                    status: 'success',
                    message: 'URL correctement assign√©e au bouton'
                });
            } else {
                results.push({
                    name: 'Bouton Slack URL',
                    status: 'error',
                    message: 'URL manquante sur le bouton'
                });
            }
            
            // V√©rifier l'accessibilit√©
            results.push({
                name: 'Accessibilit√© Bouton',
                status: 'success',
                message: 'Bouton accessible et cliquable'
            });
            
            // Simuler un clic (sans ouvrir la page)
            slackButton.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('slack-test-result').innerHTML = `
                    <div class="result info">
                        üîÑ Clic simul√© sur le bouton Slack - URL: ${this.href}
                    </div>
                `;
            });
            
            displayResults('functionality-results', results);
            
            testResults = testResults.concat(results.map(r => ({
                test: r.name,
                status: r.status,
                message: r.message
            })));
            
            updateTestSummary();
        }
        
        // Tester la compatibilit√© mobile
        function testMobileCompatibility() {
            const results = [];
            
            // D√©tecter l'appareil
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            results.push({
                name: 'D√©tection Mobile',
                status: 'info',
                message: isMobile ? 'Appareil mobile d√©tect√©' : 'Appareil desktop d√©tect√©'
            });
            
            // Tester la longueur d'URL
            if (generatedUrl) {
                const urlLength = generatedUrl.length;
                let status = 'success';
                let message = 'URL optimale pour mobile';
                
                if (urlLength > 2048) {
                    status = 'error';
                    message = 'URL trop longue pour certains navigateurs mobiles';
                } else if (urlLength > 1024) {
                    status = 'warning';
                    message = 'URL longue mais acceptable sur mobile';
                }
                
                results.push({
                    name: 'Longueur URL Mobile',
                    status: status,
                    message: `${message} (${urlLength} caract√®res)`
                });
            }
            
            // Tester le support des fonctionnalit√©s
            results.push({
                name: 'Support Base64',
                status: typeof btoa !== 'undefined' ? 'success' : 'error',
                message: typeof btoa !== 'undefined' ? 'Base64 support√©' : 'Base64 non support√©'
            });
            
            results.push({
                name: 'Support JSON',
                status: typeof JSON !== 'undefined' ? 'success' : 'error',
                message: typeof JSON !== 'undefined' ? 'JSON support√©' : 'JSON non support√©'
            });
            
            displayResults('functionality-results', results);
            
            testResults = testResults.concat(results.map(r => ({
                test: r.name,
                status: r.status,
                message: r.message
            })));
            
            updateTestSummary();
        }
        
        // Afficher les r√©sultats
        function displayResults(containerId, results) {
            const container = document.getElementById(containerId);
            const html = results.map(result => `
                <div class="result ${result.status}">
                    <strong>${result.name}:</strong> ${result.message}
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Mettre √† jour le r√©sum√© des tests
        function updateTestSummary() {
            const successCount = testResults.filter(t => t.status === 'success').length;
            const errorCount = testResults.filter(t => t.status === 'error').length;
            const warningCount = testResults.filter(t => t.status === 'warning').length;
            const infoCount = testResults.filter(t => t.status === 'info').length;
            
            let summaryClass = 'success';
            let summaryMessage = '‚úÖ Tous les tests sont pass√©s avec succ√®s';
            
            if (errorCount > 0) {
                summaryClass = 'error';
                summaryMessage = `‚ùå ${errorCount} erreur(s) d√©tect√©e(s)`;
            } else if (warningCount > 0) {
                summaryClass = 'warning';
                summaryMessage = `‚ö†Ô∏è ${warningCount} avertissement(s)`;
            }
            
            document.getElementById('test-summary').innerHTML = `
                <div class="result ${summaryClass}">
                    <strong>${summaryMessage}</strong><br>
                    Tests r√©ussis: ${successCount}, Erreurs: ${errorCount}, Avertissements: ${warningCount}, Info: ${infoCount}
                </div>
            `;
        }
        
        // Initialisation automatique
        window.addEventListener('load', function() {
            console.log('üîç Test du bouton Slack initialis√©');
            generateTestUrl(); // G√©n√©rer automatiquement l'URL au chargement
        });
    </script>
</body>
</html>