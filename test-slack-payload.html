<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payload Slack - Bouton PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        
        .json-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .slack-simulation {
            background: #4a154b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .slack-attachment {
            background: #f8f9fa;
            color: #333;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
        }
        
        .slack-attachment.good {
            border-left: 4px solid #28a745;
        }
        
        .slack-attachment.warning {
            border-left: 4px solid #ffc107;
        }
        
        .slack-button {
            display: inline-block;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 5px 0 0;
            font-weight: bold;
        }
        
        .btn-danger { background: #dc3545; }
        .btn-primary { background: #28a745; }
        
        .field-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .field {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Payload Slack - Bouton PDF</h1>
        <p>Ce test reproduit exactement le payload Slack qui devrait √™tre envoy√© avec le bouton "Ouvrir PDF".</p>
        
        <div class="test-section">
            <h2>üìä G√©n√©ration du Payload</h2>
            <button class="test-button" onclick="generateSlackPayload()">üîÑ G√©n√©rer Payload Slack</button>
            <div id="payload-result"></div>
        </div>
        
        <div class="test-section">
            <h2>üí¨ Simulation Visuelle Slack</h2>
            <div id="slack-visual" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>üìã Payload JSON</h2>
            <div id="payload-json" class="json-display"></div>
        </div>
        
        <div class="test-section">
            <h2>‚úÖ V√©rifications</h2>
            <div id="verifications"></div>
        </div>
    </div>

    <script>
        // Donn√©es de test (comme dans votre capture d'√©cran)
        const testData = {
            invoiceNumber: 'ENIXIS_20251028_62',
            orderData: {
                name: 'Edem Cyrille SOSSOUVI',
                email: 'edemcyrille@gmail.com',
                phone: '+22893369070',
                serviceLabel: 'üìä Formation Analyse de donn√©es via Excel',
                finalPrice: 25000,
                delivery: 'short',
                details: 'Formation compl√®te sur l\'analyse de donn√©es avec Excel'
            },
            paymentMethod: 'Flooz'
        };
        
        // Fonction pour formater les montants (copie du syst√®me)
        function formatFcfa(amount) {
            if (amount === null || amount === undefined || amount === '') return 'Tarif √† d√©finir';
            const n = Number(amount);
            if (!isFinite(n) || n <= 0) return 'Tarif √† d√©finir';
            return `${n.toLocaleString('fr-FR')} F CFA`;
        }
        
        // G√©n√©rer le payload Slack exact
        function generateSlackPayload() {
            const { invoiceNumber, orderData, paymentMethod } = testData;
            const companyEmail = 'contacteccorp@gmail.com';
            
            // Cr√©er l'URL de la facture
            const invoiceUrl = `https://enixis-corp.vercel.app/api/invoice?invoice=${invoiceNumber}&name=${encodeURIComponent(orderData.name || '')}&email=${encodeURIComponent(orderData.email || '')}&phone=${encodeURIComponent(orderData.phone || '')}&service=${encodeURIComponent(orderData.serviceLabel || '')}&price=${orderData.finalPrice || 0}&delivery=${orderData.delivery || 'standard'}&payment=${encodeURIComponent(paymentMethod)}`;
            
            const slackText = `
üîÑ COMMANDE EN COURS - Enixis Corp

üìÑ Num√©ro de commande: ${invoiceNumber}
üí≥ M√©thode de paiement: ${paymentMethod}
üí∞ Montant: ${formatFcfa(orderData.finalPrice)}

üë§ R√âCAPITULATIF CLIENT:
‚Ä¢ Nom: ${orderData.name}
‚Ä¢ Email: ${orderData.email}
‚Ä¢ T√©l√©phone: ${orderData.phone}

üì¶ R√âCAPITULATIF COMMANDE:
‚Ä¢ Prestation: ${orderData.serviceLabel}
‚Ä¢ D√©lai: ${orderData.delivery || 'Non sp√©cifi√©'}
${orderData.details ? `‚Ä¢ D√©tails: ${orderData.details.substring(0, 120)}${orderData.details.length > 120 ? '...' : ''}` : ''}

‚è∞ Commande cr√©√©e le: ${new Date().toLocaleString('fr-FR')}
üìß Facture envoy√©e √†: ${companyEmail}

‚ö†Ô∏è Utilisez les boutons ci-dessous pour g√©rer cette commande:
            `.trim();
            
            const payload = {
                text: slackText,
                attachments: [
                    {
                        color: '#ff9500',
                        title: `üîÑ COMMANDE EN COURS - ${invoiceNumber}`,
                        text: `R√©capitulatif g√©n√©ral avec actions de gestion`,
                        fields: [
                            {
                                title: 'Client',
                                value: `${orderData.name}\n${orderData.email}\n${orderData.phone}`,
                                short: true
                            },
                            {
                                title: 'Commande',
                                value: `${orderData.serviceLabel}\n${formatFcfa(orderData.finalPrice)}\n${paymentMethod}`,
                                short: true
                            },
                            {
                                title: 'D√©lai',
                                value: orderData.delivery || 'Standard',
                                short: true
                            },
                            {
                                title: 'Status Actuel',
                                value: '‚è≥ En attente de confirmation paiement',
                                short: true
                            }
                        ],
                        actions: [
                            {
                                type: 'button',
                                text: '‚è≥ PAIEMENT EN ATTENTE',
                                style: 'danger',
                                name: 'confirm_payment',
                                value: invoiceNumber,
                                confirm: {
                                    title: 'Confirmer le paiement',
                                    text: `Confirmer que le paiement de ${formatFcfa(orderData.finalPrice)} a √©t√© re√ßu pour la commande ${invoiceNumber} ?`,
                                    ok_text: 'Oui, confirmer',
                                    dismiss_text: 'Annuler'
                                }
                            },
                            {
                                type: 'button',
                                text: '‚è≥ COMMANDE EN COURS',
                                style: 'danger',
                                name: 'finalize_order',
                                value: invoiceNumber,
                                confirm: {
                                    title: 'Finaliser la commande',
                                    text: `Marquer la commande ${invoiceNumber} comme termin√©e et livr√©e ?`,
                                    ok_text: 'Oui, finaliser',
                                    dismiss_text: 'Annuler'
                                }
                            }
                        ],
                        footer: 'Enixis Corp - Gestion de Commande',
                        ts: Math.floor(Date.now() / 1000)
                    },
                    // Attachment pour la facture PDF
                    {
                        color: 'good',
                        title: 'üìÑ Facture PDF - T√©l√©chargeable',
                        text: `üìÑ Facture ${invoiceNumber} - Cliquez pour ouvrir et t√©l√©charger`,
                        actions: [
                            {
                                type: 'button',
                                text: 'üì• Ouvrir PDF',
                                style: 'primary',
                                name: 'open_pdf',
                                value: invoiceNumber,
                                url: invoiceUrl
                            }
                        ],
                        footer: `Facture ${invoiceNumber} - T√©l√©chargeable`,
                        ts: Math.floor(Date.now() / 1000)
                    }
                ]
            };
            
            // Afficher le payload JSON
            document.getElementById('payload-json').textContent = JSON.stringify(payload, null, 2);
            
            // Cr√©er la simulation visuelle
            createSlackVisual(payload);
            
            // Effectuer les v√©rifications
            performVerifications(payload);
            
            document.getElementById('payload-result').innerHTML = `
                <div class="result success">
                    ‚úÖ Payload Slack g√©n√©r√© avec ${payload.attachments.length} attachments
                </div>
            `;
        }
        
        // Cr√©er la simulation visuelle Slack
        function createSlackVisual(payload) {
            const slackHtml = `
                <div class="slack-simulation">
                    <div style="margin-bottom: 15px;">
                        <strong>üì¶ COMMANDE EN COURS - ${testData.invoiceNumber}</strong>
                    </div>
                    
                    <!-- Premier attachment: Gestion de commande -->
                    <div class="slack-attachment warning">
                        <div style="font-weight: bold; margin-bottom: 10px;">üîÑ COMMANDE EN COURS - ${testData.invoiceNumber}</div>
                        <div style="margin-bottom: 15px;">R√©capitulatif g√©n√©ral avec actions de gestion</div>
                        
                        <div class="field-grid">
                            <div class="field">
                                <strong>Client</strong><br>
                                ${testData.orderData.name}<br>
                                ${testData.orderData.email}<br>
                                ${testData.orderData.phone}
                            </div>
                            <div class="field">
                                <strong>Commande</strong><br>
                                ${testData.orderData.serviceLabel}<br>
                                ${formatFcfa(testData.orderData.finalPrice)}<br>
                                ${testData.paymentMethod}
                            </div>
                            <div class="field">
                                <strong>D√©lai</strong><br>
                                ${testData.orderData.delivery}
                            </div>
                            <div class="field">
                                <strong>Status Actuel</strong><br>
                                ‚è≥ En attente de confirmation paiement
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="slack-button btn-danger">‚è≥ PAIEMENT EN ATTENTE</button>
                            <button class="slack-button btn-danger">‚è≥ COMMANDE EN COURS</button>
                        </div>
                        
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            Enixis Corp - Gestion de Commande
                        </div>
                    </div>
                    
                    <!-- Deuxi√®me attachment: Facture PDF -->
                    <div class="slack-attachment good">
                        <div style="font-weight: bold; margin-bottom: 10px;">üìÑ Facture PDF - T√©l√©chargeable</div>
                        <div style="margin-bottom: 10px;">üìÑ Facture ${testData.invoiceNumber} - Cliquez pour ouvrir et t√©l√©charger</div>
                        <a href="${payload.attachments[1].actions[0].url}" class="slack-button btn-primary" target="_blank">üì• Ouvrir PDF</a>
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            Facture ${testData.invoiceNumber} - T√©l√©chargeable
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('slack-visual').innerHTML = slackHtml;
            document.getElementById('slack-visual').style.display = 'block';
        }
        
        // Effectuer les v√©rifications
        function performVerifications(payload) {
            const verifications = [];
            
            // V√©rifier le nombre d'attachments
            if (payload.attachments && payload.attachments.length === 2) {
                verifications.push({
                    name: 'Nombre d\'attachments',
                    status: 'success',
                    message: `2 attachments trouv√©s (correct)`
                });
            } else {
                verifications.push({
                    name: 'Nombre d\'attachments',
                    status: 'error',
                    message: `${payload.attachments?.length || 0} attachments trouv√©s (attendu: 2)`
                });
            }
            
            // V√©rifier l'attachment PDF
            const pdfAttachment = payload.attachments?.find(att => att.title?.includes('Facture PDF'));
            if (pdfAttachment) {
                verifications.push({
                    name: 'Attachment PDF',
                    status: 'success',
                    message: 'Attachment "Facture PDF" trouv√©'
                });
                
                // V√©rifier le bouton PDF
                const pdfButton = pdfAttachment.actions?.find(action => action.name === 'open_pdf');
                if (pdfButton && pdfButton.url) {
                    verifications.push({
                        name: 'Bouton PDF',
                        status: 'success',
                        message: 'Bouton "Ouvrir PDF" avec URL trouv√©'
                    });
                    
                    // V√©rifier l'URL
                    if (pdfButton.url.includes('api/invoice') && pdfButton.url.includes('invoice=')) {
                        verifications.push({
                            name: 'URL Facture',
                            status: 'success',
                            message: 'URL de facture valide'
                        });
                    } else {
                        verifications.push({
                            name: 'URL Facture',
                            status: 'error',
                            message: 'URL de facture invalide'
                        });
                    }
                } else {
                    verifications.push({
                        name: 'Bouton PDF',
                        status: 'error',
                        message: 'Bouton "Ouvrir PDF" manquant ou sans URL'
                    });
                }
            } else {
                verifications.push({
                    name: 'Attachment PDF',
                    status: 'error',
                    message: 'Attachment "Facture PDF" manquant'
                });
            }
            
            // V√©rifier les boutons de gestion
            const managementAttachment = payload.attachments?.find(att => att.title?.includes('COMMANDE EN COURS'));
            if (managementAttachment && managementAttachment.actions && managementAttachment.actions.length === 2) {
                verifications.push({
                    name: 'Boutons de Gestion',
                    status: 'success',
                    message: '2 boutons de gestion trouv√©s'
                });
            } else {
                verifications.push({
                    name: 'Boutons de Gestion',
                    status: 'warning',
                    message: 'Boutons de gestion manquants ou incomplets'
                });
            }
            
            // Afficher les v√©rifications
            const verificationsHtml = verifications.map(v => `
                <div class="result ${v.status}">
                    <strong>${v.name}:</strong> ${v.message}
                </div>
            `).join('');
            
            document.getElementById('verifications').innerHTML = verificationsHtml;
        }
        
        // Initialisation automatique
        window.addEventListener('load', function() {
            console.log('üîç Test payload Slack initialis√©');
            generateSlackPayload();
        });
    </script>
</body>
</html>