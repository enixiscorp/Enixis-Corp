<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test URL Facture Optimis√©e</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .test-link {
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 10px 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .test-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .url-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #28a745;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test URL Facture Optimis√©e</h1>
        <p>Ce test v√©rifie le syst√®me d'optimisation automatique des URLs de facture pour une meilleure compatibilit√© mobile.</p>
        
        <div class="test-section">
            <h2>üìä Statistiques des URLs</h2>
            <div class="stats" id="url-stats">
                <!-- Les statistiques seront g√©n√©r√©es ici -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîó URL Traditionnelle (Param√®tres s√©par√©s)</h2>
            <div class="url-display" id="traditional-url"></div>
            <div id="traditional-result"></div>
            <a href="#" id="traditional-link" class="test-link" target="_blank">üìÑ Tester URL Traditionnelle</a>
        </div>
        
        <div class="test-section">
            <h2>üöÄ URL Optimis√©e (Base64)</h2>
            <div class="url-display" id="optimized-url"></div>
            <div id="optimized-result"></div>
            <a href="#" id="optimized-link" class="test-link" target="_blank">üìÑ Tester URL Optimis√©e</a>
        </div>
        
        <div class="test-section">
            <h2>üéØ Test Automatique</h2>
            <p>Le syst√®me choisit automatiquement la meilleure URL selon la longueur :</p>
            <div class="url-display" id="auto-url"></div>
            <div id="auto-result"></div>
            <a href="#" id="auto-link" class="test-link" target="_blank">üìÑ Tester URL Automatique</a>
        </div>
        
        <div class="test-section">
            <h2>üì± Tests de Compatibilit√©</h2>
            <div id="compatibility-results"></div>
        </div>
        
        <div class="test-section">
            <h2>üí° Recommandations</h2>
            <div id="recommendations"></div>
        </div>
    </div>

    <script>
        // Donn√©es de test (cas r√©el avec des donn√©es longues)
        const testData = {
            invoice: 'ENIXIS_20251028_34',
            name: 'Edem Cyrille SOSSOUVI',
            email: 'edemcyrille@gmail.com',
            phone: '+22893369070',
            service: 'üéì Formation Coaching Emploi - Optimisation CV et Strat√©gies de Recherche d\'Emploi',
            price: 30000,
            delivery: 'urgent',
            payment: 'USDT (TRC-20) - Paiement Crypto S√©curis√©'
        };
        
        // Fonction pour g√©n√©rer une URL traditionnelle
        function generateTraditionalUrl(invoiceNumber, data) {
            const baseUrl = 'https://enixis-corp.vercel.app/api/invoice';
            const params = new URLSearchParams({
                invoice: invoiceNumber,
                name: data.name,
                email: data.email,
                phone: data.phone,
                service: data.service,
                price: data.price.toString(),
                delivery: data.delivery,
                payment: data.payment
            });
            
            return `${baseUrl}?${params.toString()}`;
        }
        
        // Fonction pour g√©n√©rer une URL optimis√©e
        function generateOptimizedUrl(invoiceNumber, data) {
            const baseUrl = 'https://enixis-corp.vercel.app/api/invoice';
            const encodedData = btoa(JSON.stringify(data));
            return `${baseUrl}?invoice=${invoiceNumber}&data=${encodedData}`;
        }
        
        // Fonction pour choisir automatiquement la meilleure URL
        function generateOptimizedInvoiceUrl(invoiceNumber, data) {
            const traditionalUrl = generateTraditionalUrl(invoiceNumber, data);
            
            if (traditionalUrl.length > 1024) {
                console.log(`‚ö†Ô∏è URL traditionnelle trop longue (${traditionalUrl.length} caract√®res), utilisation de la version optimis√©e`);
                
                try {
                    const optimizedUrl = generateOptimizedUrl(invoiceNumber, data);
                    console.log(`‚úÖ URL optimis√©e g√©n√©r√©e (${optimizedUrl.length} caract√®res, r√©duction de ${((traditionalUrl.length - optimizedUrl.length) / traditionalUrl.length * 100).toFixed(1)}%)`);
                    return optimizedUrl;
                } catch (error) {
                    console.error('‚ùå Erreur g√©n√©ration URL optimis√©e:', error);
                    return traditionalUrl;
                }
            } else {
                console.log(`‚úÖ URL traditionnelle utilis√©e (${traditionalUrl.length} caract√®res)`);
                return traditionalUrl;
            }
        }
        
        // Fonction pour analyser une URL
        function analyzeUrl(url, type) {
            const analysis = {
                type: type,
                length: url.length,
                status: 'success',
                message: '',
                issues: [],
                compatibility: 'excellent'
            };
            
            // Analyser la longueur
            if (url.length > 2048) {
                analysis.status = 'error';
                analysis.compatibility = 'mauvaise';
                analysis.issues.push('URL trop longue (>2048 caract√®res) - ne fonctionnera pas sur certains navigateurs');
            } else if (url.length > 1024) {
                analysis.status = 'warning';
                analysis.compatibility = 'limit√©e';
                analysis.issues.push('URL longue (>1024 caract√®res) - peut poser des probl√®mes sur certains appareils mobiles');
            } else if (url.length > 512) {
                analysis.compatibility = 'bonne';
            }
            
            // Analyser l'encodage
            const encodedChars = url.match(/%[0-9A-Fa-f]{2}/g);
            if (encodedChars && encodedChars.length > 20) {
                analysis.issues.push(`Beaucoup de caract√®res encod√©s (${encodedChars.length}) - peut causer des probl√®mes`);
            }
            
            // Analyser les caract√®res sp√©ciaux
            const specialChars = url.match(/[^\w\-\.~:\/\?#\[\]@!\$&'\(\)\*\+,;=%]/g);
            if (specialChars && specialChars.length > 0) {
                analysis.issues.push(`Caract√®res sp√©ciaux non encod√©s: ${[...new Set(specialChars)].slice(0, 5).join(', ')}`);
            }
            
            if (analysis.issues.length === 0) {
                analysis.message = `‚úÖ URL ${analysis.compatibility} - ${analysis.length} caract√®res`;
            } else {
                analysis.message = `${analysis.issues.length} probl√®me(s) d√©tect√©(s)`;
            }
            
            return analysis;
        }
        
        // Fonction pour afficher les statistiques
        function displayStats(traditional, optimized, auto) {
            const reduction = ((traditional.length - optimized.length) / traditional.length * 100).toFixed(1);
            const savings = traditional.length - optimized.length;
            
            document.getElementById('url-stats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${traditional.length}</div>
                    <div class="stat-label">URL Traditionnelle<br>(caract√®res)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${optimized.length}</div>
                    <div class="stat-label">URL Optimis√©e<br>(caract√®res)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${reduction}%</div>
                    <div class="stat-label">R√©duction<br>de taille</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${savings}</div>
                    <div class="stat-label">Caract√®res<br>√©conomis√©s</div>
                </div>
            `;
        }
        
        // Fonction pour afficher les r√©sultats de compatibilit√©
        function displayCompatibilityResults(analyses) {
            const results = analyses.map(analysis => {
                const statusClass = analysis.status;
                return `
                    <div class="result ${statusClass}">
                        <strong>${analysis.type}:</strong> ${analysis.message}<br>
                        <strong>Compatibilit√©:</strong> ${analysis.compatibility}<br>
                        ${analysis.issues.length > 0 ? '<strong>Probl√®mes:</strong><ul>' + analysis.issues.map(issue => `<li>${issue}</li>`).join('') + '</ul>' : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('compatibility-results').innerHTML = results;
        }
        
        // Fonction pour g√©n√©rer les recommandations
        function generateRecommendations(analyses) {
            const recommendations = [];
            
            const traditionalAnalysis = analyses.find(a => a.type === 'URL Traditionnelle');
            const optimizedAnalysis = analyses.find(a => a.type === 'URL Optimis√©e');
            const autoAnalysis = analyses.find(a => a.type === 'URL Automatique');
            
            if (traditionalAnalysis.length > 1024) {
                recommendations.push('‚úÖ Le syst√®me d\'optimisation automatique est recommand√© pour ce type de donn√©es');
            }
            
            if (optimizedAnalysis.compatibility === 'excellent') {
                recommendations.push('‚úÖ L\'URL optimis√©e offre une excellente compatibilit√© mobile');
            }
            
            recommendations.push('‚úÖ Tester les URLs sur diff√©rents appareils (iOS, Android, Desktop)');
            recommendations.push('‚úÖ V√©rifier le fonctionnement dans diff√©rents navigateurs (Chrome, Safari, Firefox)');
            recommendations.push('‚úÖ Surveiller les logs d\'erreur pour d√©tecter les probl√®mes de compatibilit√©');
            
            if (traditionalAnalysis.length > 2048) {
                recommendations.push('‚ö†Ô∏è Consid√©rer l\'utilisation de POST au lieu de GET pour les tr√®s longues donn√©es');
            }
            
            document.getElementById('recommendations').innerHTML = `
                <ul>
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
        }
        
        // Initialisation
        window.addEventListener('load', function() {
            const traditionalUrl = generateTraditionalUrl(testData.invoice, testData);
            const optimizedUrl = generateOptimizedUrl(testData.invoice, testData);
            const autoUrl = generateOptimizedInvoiceUrl(testData.invoice, testData);
            
            // Analyser les URLs
            const traditionalAnalysis = analyzeUrl(traditionalUrl, 'URL Traditionnelle');
            const optimizedAnalysis = analyzeUrl(optimizedUrl, 'URL Optimis√©e');
            const autoAnalysis = analyzeUrl(autoUrl, 'URL Automatique');
            
            // Afficher les statistiques
            displayStats(traditionalUrl, optimizedUrl, autoUrl);
            
            // Afficher les URLs
            document.getElementById('traditional-url').textContent = traditionalUrl;
            document.getElementById('optimized-url').textContent = optimizedUrl;
            document.getElementById('auto-url').textContent = autoUrl;
            
            // Afficher les r√©sultats
            document.getElementById('traditional-result').innerHTML = `<div class="result ${traditionalAnalysis.status}">${traditionalAnalysis.message}</div>`;
            document.getElementById('optimized-result').innerHTML = `<div class="result ${optimizedAnalysis.status}">${optimizedAnalysis.message}</div>`;
            document.getElementById('auto-result').innerHTML = `<div class="result ${autoAnalysis.status}">${autoAnalysis.message}</div>`;
            
            // Configurer les liens
            document.getElementById('traditional-link').href = traditionalUrl;
            document.getElementById('optimized-link').href = optimizedUrl;
            document.getElementById('auto-link').href = autoUrl;
            
            // Afficher les r√©sultats de compatibilit√©
            displayCompatibilityResults([traditionalAnalysis, optimizedAnalysis, autoAnalysis]);
            
            // G√©n√©rer les recommandations
            generateRecommendations([traditionalAnalysis, optimizedAnalysis, autoAnalysis]);
            
            console.log('üîç Test d\'optimisation URL termin√©');
            console.log('üìä URL Traditionnelle:', traditionalUrl.length, 'caract√®res');
            console.log('üöÄ URL Optimis√©e:', optimizedUrl.length, 'caract√®res');
            console.log('üéØ URL Automatique:', autoUrl.length, 'caract√®res');
        });
    </script>
</body>
</html>