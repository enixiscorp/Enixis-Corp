<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Notification Slack</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .json-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .url-test {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Notification Slack</h1>
        <p>Cet outil simule et d√©bogue la g√©n√©ration de notifications Slack avec le bouton PDF.</p>
        
        <div class="debug-section">
            <h2>üìä Donn√©es de Test</h2>
            <button class="test-button" onclick="generateTestData()">üîÑ G√©n√©rer Donn√©es Test</button>
            <div id="test-data-display" class="json-display"></div>
        </div>
        
        <div class="debug-section">
            <h2>üîó G√©n√©ration URL</h2>
            <button class="test-button" onclick="testUrlGeneration()">üß™ Tester URL</button>
            <div id="url-result"></div>
            <div id="url-display" class="url-test"></div>
        </div>
        
        <div class="debug-section">
            <h2>üì® Payload Slack</h2>
            <button class="test-button" onclick="generateSlackPayload()">üìã G√©n√©rer Payload</button>
            <div id="payload-result"></div>
            <div id="payload-display" class="json-display"></div>
        </div>
        
        <div class="debug-section">
            <h2>üß™ Test Complet</h2>
            <button class="test-button" onclick="runCompleteTest()">üöÄ Test Complet</button>
            <div id="complete-test-result"></div>
        </div>
        
        <div class="debug-section">
            <h2>üìã R√©sultats Debug</h2>
            <div id="debug-summary"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let testOrderData = null;
        let generatedUrl = null;
        let slackPayload = null;
        let debugResults = [];
        
        // Donn√©es de test r√©alistes
        function generateTestData() {
            testOrderData = {
                name: 'Edem Cyrille SOSSOUVI',
                email: 'edemcyrille@gmail.com',
                phone: '+22893369070',
                serviceLabel: 'üéì Formation Coaching Emploi',
                finalPrice: 30000,
                delivery: 'urgent',
                details: 'Formation compl√®te pour optimiser la recherche d\'emploi'
            };
            
            document.getElementById('test-data-display').textContent = JSON.stringify(testOrderData, null, 2);
            
            addDebugResult('G√©n√©ration Donn√©es', 'success', 'Donn√©es de test g√©n√©r√©es');
        }
        
        // Fonction pour g√©n√©rer une URL optimis√©e (copie du syst√®me)
        function generateOptimizedInvoiceUrl(invoiceNumber, data) {
            const baseUrl = 'https://enixis-corp.vercel.app/api/invoice';
            
            // Calculer la longueur de l'URL traditionnelle
            const traditionalParams = new URLSearchParams({
                invoice: invoiceNumber,
                name: data.name,
                email: data.email,
                phone: data.phone,
                service: data.service,
                price: data.price.toString(),
                delivery: data.delivery,
                payment: data.payment
            });
            const traditionalUrl = `${baseUrl}?${traditionalParams.toString()}`;
            
            // Si l'URL traditionnelle est trop longue, utiliser la version optimis√©e
            if (traditionalUrl.length > 1024) {
                console.log(`‚ö†Ô∏è URL traditionnelle trop longue (${traditionalUrl.length} caract√®res), utilisation de la version optimis√©e`);
                
                try {
                    const encodedData = btoa(JSON.stringify(data));
                    const optimizedUrl = `${baseUrl}?invoice=${invoiceNumber}&data=${encodedData}`;
                    
                    console.log(`‚úÖ URL optimis√©e g√©n√©r√©e (${optimizedUrl.length} caract√®res, r√©duction de ${((traditionalUrl.length - optimizedUrl.length) / traditionalUrl.length * 100).toFixed(1)}%)`);
                    return optimizedUrl;
                } catch (error) {
                    console.error('‚ùå Erreur g√©n√©ration URL optimis√©e:', error);
                    return traditionalUrl;
                }
            } else {
                console.log(`‚úÖ URL traditionnelle utilis√©e (${traditionalUrl.length} caract√®res)`);
                return traditionalUrl;
            }
        }
        
        // Tester la g√©n√©ration d'URL
        function testUrlGeneration() {
            if (!testOrderData) {
                generateTestData();
            }
            
            try {
                const invoiceNumber = 'ENIXIS_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '_DEBUG';
                const paymentMethod = 'Test Payment';
                
                generatedUrl = generateOptimizedInvoiceUrl(invoiceNumber, {
                    name: testOrderData.name,
                    email: testOrderData.email,
                    phone: testOrderData.phone,
                    service: testOrderData.serviceLabel,
                    price: testOrderData.finalPrice,
                    delivery: testOrderData.delivery,
                    payment: paymentMethod
                });
                
                document.getElementById('url-display').textContent = generatedUrl;
                document.getElementById('url-result').innerHTML = `
                    <div class="result success">
                        ‚úÖ URL g√©n√©r√©e avec succ√®s (${generatedUrl.length} caract√®res)
                    </div>
                `;
                
                addDebugResult('G√©n√©ration URL', 'success', `URL g√©n√©r√©e (${generatedUrl.length} caract√®res)`);
                
            } catch (error) {
                document.getElementById('url-result').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur g√©n√©ration URL: ${error.message}
                    </div>
                `;
                
                addDebugResult('G√©n√©ration URL', 'error', error.message);
            }
        }
        
        // G√©n√©rer le payload Slack
        function generateSlackPayload() {
            if (!testOrderData || !generatedUrl) {
                testUrlGeneration();
            }
            
            try {
                const invoiceNumber = 'ENIXIS_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '_DEBUG';
                const paymentMethod = 'Test Payment';
                
                // Fonction pour formater les montants
                function formatFcfa(amount) {
                    if (amount === null || amount === undefined || amount === '') return 'Tarif √† d√©finir';
                    const n = Number(amount);
                    if (!isFinite(n) || n <= 0) return 'Tarif √† d√©finir';
                    return `${n.toLocaleString('fr-FR')} F CFA`;
                }
                
                const slackText = `
üîÑ COMMANDE EN COURS - Enixis Corp

üìÑ Num√©ro de commande: ${invoiceNumber}
üí≥ M√©thode de paiement: ${paymentMethod}
üí∞ Montant: ${formatFcfa(testOrderData.finalPrice)}

üë§ R√âCAPITULATIF CLIENT:
‚Ä¢ Nom: ${testOrderData.name}
‚Ä¢ Email: ${testOrderData.email}
‚Ä¢ T√©l√©phone: ${testOrderData.phone}

üì¶ R√âCAPITULATIF COMMANDE:
‚Ä¢ Prestation: ${testOrderData.serviceLabel}
‚Ä¢ D√©lai: ${testOrderData.delivery || 'Non sp√©cifi√©'}
${testOrderData.details ? `‚Ä¢ D√©tails: ${testOrderData.details.substring(0, 120)}${testOrderData.details.length > 120 ? '...' : ''}` : ''}

‚è∞ Commande cr√©√©e le: ${new Date().toLocaleString('fr-FR')}
üìß Facture envoy√©e √†: contacteccorp@gmail.com

‚ö†Ô∏è Utilisez les boutons ci-dessous pour g√©rer cette commande:
                `.trim();
                
                slackPayload = {
                    text: slackText,
                    attachments: [
                        {
                            color: '#ff9500',
                            title: `üîÑ COMMANDE EN COURS - ${invoiceNumber}`,
                            text: `R√©capitulatif g√©n√©ral avec actions de gestion`,
                            fields: [
                                {
                                    title: 'Client',
                                    value: `${testOrderData.name}\n${testOrderData.email}\n${testOrderData.phone}`,
                                    short: true
                                },
                                {
                                    title: 'Commande',
                                    value: `${testOrderData.serviceLabel}\nMontant: ${formatFcfa(testOrderData.finalPrice)}\nD√©lai: ${testOrderData.delivery}`,
                                    short: true
                                }
                            ],
                            actions: [
                                {
                                    type: 'button',
                                    text: '‚è≥ PAIEMENT EN ATTENTE',
                                    style: 'danger',
                                    name: 'confirm_payment',
                                    value: invoiceNumber,
                                    confirm: {
                                        title: 'Confirmer le paiement',
                                        text: `Confirmer que le paiement de ${formatFcfa(testOrderData.finalPrice)} a √©t√© re√ßu pour la commande ${invoiceNumber} ?`,
                                        ok_text: 'Oui, confirmer',
                                        dismiss_text: 'Annuler'
                                    }
                                },
                                {
                                    type: 'button',
                                    text: '‚è≥ COMMANDE EN COURS',
                                    style: 'danger',
                                    name: 'finalize_order',
                                    value: invoiceNumber,
                                    confirm: {
                                        title: 'Finaliser la commande',
                                        text: `Marquer la commande ${invoiceNumber} comme termin√©e et livr√©e ?`,
                                        ok_text: 'Oui, finaliser',
                                        dismiss_text: 'Annuler'
                                    }
                                }
                            ],
                            footer: 'Enixis Corp - Gestion de Commande',
                            ts: Math.floor(Date.now() / 1000)
                        },
                        // Attachment pour la facture PDF
                        {
                            color: 'good',
                            title: 'üìÑ Facture PDF - T√©l√©chargeable',
                            text: `üìÑ Facture ${invoiceNumber} - Accessible via le lien de t√©l√©chargement`,
                            actions: [
                                {
                                    type: 'button',
                                    text: 'üì• Ouvrir PDF',
                                    style: 'primary',
                                    name: 'open_pdf',
                                    value: invoiceNumber,
                                    url: generatedUrl
                                }
                            ],
                            footer: `Facture ${invoiceNumber} - T√©l√©chargeable depuis n'importe quel appareil`,
                            ts: Math.floor(Date.now() / 1000)
                        }
                    ]
                };
                
                document.getElementById('payload-display').textContent = JSON.stringify(slackPayload, null, 2);
                document.getElementById('payload-result').innerHTML = `
                    <div class="result success">
                        ‚úÖ Payload Slack g√©n√©r√© avec ${slackPayload.attachments.length} attachments
                    </div>
                `;
                
                addDebugResult('Payload Slack', 'success', `Payload g√©n√©r√© avec ${slackPayload.attachments.length} attachments`);
                
            } catch (error) {
                document.getElementById('payload-result').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur g√©n√©ration payload: ${error.message}
                    </div>
                `;
                
                addDebugResult('Payload Slack', 'error', error.message);
            }
        }
        
        // Test complet
        function runCompleteTest() {
            debugResults = []; // Reset
            
            try {
                // 1. G√©n√©rer les donn√©es
                generateTestData();
                
                // 2. Tester l'URL
                testUrlGeneration();
                
                // 3. G√©n√©rer le payload
                generateSlackPayload();
                
                // 4. V√©rifications finales
                const checks = [];
                
                // V√©rifier que l'URL est valide
                if (generatedUrl && generatedUrl.startsWith('https://')) {
                    checks.push({ name: 'URL Valide', status: 'success', message: 'URL correctement form√©e' });
                } else {
                    checks.push({ name: 'URL Valide', status: 'error', message: 'URL invalide ou manquante' });
                }
                
                // V√©rifier que le payload a les bonnes propri√©t√©s
                if (slackPayload && slackPayload.attachments && slackPayload.attachments.length >= 2) {
                    checks.push({ name: 'Attachments Slack', status: 'success', message: `${slackPayload.attachments.length} attachments trouv√©s` });
                } else {
                    checks.push({ name: 'Attachments Slack', status: 'error', message: 'Attachments manquants ou insuffisants' });
                }
                
                // V√©rifier le bouton PDF
                const pdfAttachment = slackPayload?.attachments?.find(att => att.title?.includes('Facture PDF'));
                if (pdfAttachment && pdfAttachment.actions && pdfAttachment.actions.length > 0) {
                    const pdfButton = pdfAttachment.actions.find(action => action.name === 'open_pdf');
                    if (pdfButton && pdfButton.url) {
                        checks.push({ name: 'Bouton PDF', status: 'success', message: 'Bouton PDF avec URL trouv√©' });
                    } else {
                        checks.push({ name: 'Bouton PDF', status: 'error', message: 'Bouton PDF sans URL' });
                    }
                } else {
                    checks.push({ name: 'Bouton PDF', status: 'error', message: 'Bouton PDF manquant' });
                }
                
                // Afficher les r√©sultats
                const resultsHtml = checks.map(check => `
                    <div class="result ${check.status}">
                        <strong>${check.name}:</strong> ${check.message}
                    </div>
                `).join('');
                
                document.getElementById('complete-test-result').innerHTML = resultsHtml;
                
                // Ajouter aux r√©sultats debug
                checks.forEach(check => addDebugResult(check.name, check.status, check.message));
                
            } catch (error) {
                document.getElementById('complete-test-result').innerHTML = `
                    <div class="result error">
                        ‚ùå Erreur test complet: ${error.message}
                    </div>
                `;
                
                addDebugResult('Test Complet', 'error', error.message);
            }
            
            updateDebugSummary();
        }
        
        // Ajouter un r√©sultat de debug
        function addDebugResult(test, status, message) {
            debugResults.push({ test, status, message, timestamp: new Date().toLocaleTimeString() });
            updateDebugSummary();
        }
        
        // Mettre √† jour le r√©sum√© debug
        function updateDebugSummary() {
            const successCount = debugResults.filter(r => r.status === 'success').length;
            const errorCount = debugResults.filter(r => r.status === 'error').length;
            const warningCount = debugResults.filter(r => r.status === 'warning').length;
            
            let summaryClass = 'success';
            let summaryMessage = '‚úÖ Tous les tests sont pass√©s';
            
            if (errorCount > 0) {
                summaryClass = 'error';
                summaryMessage = `‚ùå ${errorCount} erreur(s) d√©tect√©e(s)`;
            } else if (warningCount > 0) {
                summaryClass = 'warning';
                summaryMessage = `‚ö†Ô∏è ${warningCount} avertissement(s)`;
            }
            
            const detailsHtml = debugResults.map(result => `
                <div class="result ${result.status}">
                    <strong>[${result.timestamp}] ${result.test}:</strong> ${result.message}
                </div>
            `).join('');
            
            document.getElementById('debug-summary').innerHTML = `
                <div class="result ${summaryClass}">
                    <strong>${summaryMessage}</strong><br>
                    Succ√®s: ${successCount}, Erreurs: ${errorCount}, Avertissements: ${warningCount}
                </div>
                ${detailsHtml}
            `;
        }
        
        // Initialisation
        window.addEventListener('load', function() {
            console.log('üîç Debug Slack initialis√©');
            // Lancer automatiquement le test complet
            setTimeout(() => {
                runCompleteTest();
            }, 1000);
        });
    </script>
</body>
</html>